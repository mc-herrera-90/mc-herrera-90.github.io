<div class="
      file-viewer
      editor-container
      d-flex
      position-relative
      rounded shadow-sm
      overflow-hidden
      mb-4
      "
    style="
      border:1px solid var(--main-border-color);
      height: {{ include.height | default: '510px' }}; max-height: {{ include.height | default: '510px' }};
      ">
  <div class="file-tree">
    <ul data-name="{{ include.name }}" class="file-tree-root pt-4"></ul>
  </div>
  <div class="code-panel" id="panel-code-{{ include.name }}">
    <div style="background: var(--sidebar-bg);" class="code-panel-header">
        <span id="{{ include.name }}-filename" class="p-2" style="background: var(--highlight-bg-color); font-size: 0.8rem; color: var(--toc-highlight)">Sin archivo x</span>
    </div>
    {% for file in include.files %}
      <pre id="{{ include.name }}-file-{{ forloop.index0 }}" class="file-content pt-0 list-unstyled">
        {% if file.include %}
          <code class="hljs-{{ file.language | downcase }} pt-0" contenteditable="true" spellcheck="false">{% include {{ file.content_file }} %}</code>
          {% else %}
          <code class="hljs-{{ file.language | downcase }} pt-0" contenteditable="true" spellcheck="false">{{ file.content_file | replace: '<', '&lt;' | replace: '>', '&gt;' }}</code>
        {% endif %}
      </pre>
    {% endfor %}
    <p id="default-msg" class="p-3" data-name="{{ include.name }}">Selecciona un archivo para ver su contenido</p>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const viewer = document.getElementById('panel-code-{{ include.name }}');
  const allPre = viewer.querySelectorAll('.file-content');

  const htmlTag = document.documentElement;
  const hljsStyle = document.createElement('link');
  hljsStyle.rel = 'stylesheet';
  const darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

  function updateTheme() {
    const isDark = htmlTag.getAttribute('data-mode') === 'dark' || 
      (htmlTag.getAttribute('data-mode') === 'auto' && darkMode) ||
      (!htmlTag.getAttribute('data-mode') && darkMode);
    hljsStyle.href = isDark 
    ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css'
    : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css';
  }
  document.head.appendChild(hljsStyle);
  updateTheme();
  viewer.querySelectorAll('.file-content code').forEach(el => hljs.highlightElement(el));
  allPre.forEach(pre => pre.style.display = 'none');
  viewer.querySelector('#default-msg').style.display = 'block';

  const treeRoot = document.querySelector('[data-name="{{ include.name }}"]');

  const files = {{ include.files | jsonify }};

  function buildTree(files, prefix) {
    const root = {};
    files.forEach((file, index) => {
      const parts = file.name.split('/');
      let current = root;
      parts.forEach((part, i) => {
        if (!current[part]) {
          current[part] = (i === parts.length - 1)
            ? { __file: true, data: file, id: `${prefix}-file-${index}` }
            : {};
        }
        current = current[part];
      });
    });
    return root;
  }
  function renderTree(node, parentUl) {
    Object.keys(node).forEach(key => {
      const value = node[key];
      const li = document.createElement('li');

      if (value.__file) {
        const ext = key.split('.').pop().toLowerCase();
        let iconClass = "fa-regular fa-file";
        let iconColor = "#aaa";

        switch (ext) {
          case "js":
            iconClass = "fa-brands fa-js";
            iconColor = "#f7df1e";
            break;
          case "json":
            iconClass = "vscode-icons--file-type-json-official";
            iconColor = "#3c873a";
            break;
          case "html":
            iconClass = "fa-brands fa-html5";
            iconColor = "#e34f26";
            break;
          case "css":
            iconClass = "fa-brands fa-css3-alt";
            iconColor = "#264de4";
            break;
          case "md":
            iconClass = "fa-brands fa-markdown";
            iconColor = "#6a737d";
            break;
          case "txt":
            iconClass = "fa-regular fa-file-lines"; 
            iconColor = "#999";
            break;
          case "jsx":
            iconClass = "fa-brands fa-react";
            iconColor = "#61DBFB";
            break;
          case "eml":
            iconClass = "fa-solid fa-envelope-open-text text-danger";
            iconColor = "";
            break;
        }

        li.innerHTML = `<span class="file" data-id="${value.id}" title="${key}">
                          <i class="${iconClass}" style="color:${iconColor}"></i> ${key}
                        </span>`;
        const spanFile = li.querySelector('.file');
        spanFile.style.display = "inline-block";
        spanFile.style.maxWidth = "calc(100% - 24px)";
        spanFile.style.overflow = "hidden";
        spanFile.style.textOverflow = "ellipsis";
        spanFile.style.verticalAlign = "middle";

      } else {
        li.innerHTML = `<span class="folder"><i class="fa-solid fa-folder text-warning"></i> ${key}</span>`;
        const ul = document.createElement('ul');
        ul.style.display = "none";
        renderTree(value, ul);
        li.appendChild(ul);

        // li.addEventListener('click', () => {
        //   ul.style.display = ul.style.display === "none" ? "block" : "none";
        // });
        li.querySelector('.folder').addEventListener('click', () => {
          ul.style.display = ul.style.display === "none" ? "block" : "none";
        });
      }

      if (value.__file) {
        
        li.addEventListener('click', () => {
          allPre.forEach(fc => fc.style.display='none');
          viewer.querySelector('#default-msg').style.display='none';
          const block = viewer.querySelector('#' + value.id);
          if(block) {
            block.style.display='block';
            hljs.highlightElement(block.querySelector('code'));
          }
          const parts = value.data.name.split('/');
          const filename = parts[parts.length - 1];
          const filenameSpan = document.getElementById('{{ include.name }}-filename');
          filenameSpan.title = filename;
          filenameSpan.innerText = filename;
          document.querySelectorAll('li').forEach(el => el.classList.remove('active'));
          li.classList.add('active');
        });
      }
      parentUl.appendChild(li);
    });
  }
  const tree = buildTree(files, treeRoot.dataset.name);
  renderTree(tree, treeRoot);

  const observer = new MutationObserver(updateTheme);
  observer.observe(htmlTag, { attributes: true, attributeFilter: ['data-mode'] });

    document.querySelectorAll('.file-viewer.editor-container').forEach(container => {
    const fileTree = container.querySelector('.file-tree');
    const codePanel = container.querySelector('.code-panel');
    let isResizing = false;

    const resizer = document.createElement('div');
    resizer.style.position = 'absolute';
    resizer.style.zIndex = '100';
    resizer.style.background = 'transparent';
    container.appendChild(resizer);

    function updateResizer() {
      const style = window.getComputedStyle(container);
      const isRow = style.flexDirection === 'row';

      if (isRow) {
        resizer.style.cursor = 'col-resize';
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.left = fileTree.offsetWidth + 'px';
        resizer.style.top = '0';
        fileTree.style.flex = '0 0 auto';
        codePanel.style.flex = '1 1 auto';
      } else {
        resizer.style.cursor = 'row-resize';
        resizer.style.height = '5px';
        resizer.style.width = '100%';
        resizer.style.top = fileTree.offsetHeight + 'px';
        resizer.style.left = '0';
        fileTree.style.flex = '0 0 auto';
        codePanel.style.flex = '1 1 auto';
      }
    }

    updateResizer();

    window.addEventListener('resize', updateResizer);

    resizer.addEventListener('mousedown', () => {
      isResizing = true;
      document.body.style.cursor = resizer.style.cursor;
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const rect = container.getBoundingClientRect();
      const style = window.getComputedStyle(container);
      const isRow = style.flexDirection === 'row';

      if (isRow) {
        let newWidth = e.clientX - rect.left;
        if (newWidth < 100) newWidth = 100;
        if (newWidth > rect.width - 100) newWidth = rect.width - 100;
        fileTree.style.width = newWidth + 'px';
        codePanel.style.width = `calc(100% - ${newWidth}px)`;
        resizer.style.left = newWidth + 'px';
      } else {
        let newHeight = e.clientY - rect.top;
        if (newHeight < 50) newHeight = 50;
        if (newHeight > rect.height - 50) newHeight = rect.height - 50;
        fileTree.style.height = newHeight + 'px';
        codePanel.style.height = `calc(100% - ${newHeight}px)`;
        resizer.style.top = newHeight + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = 'default';
      }
    });
  });
});

</script>
